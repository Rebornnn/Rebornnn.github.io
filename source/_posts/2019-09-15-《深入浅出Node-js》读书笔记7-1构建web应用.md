---
title: 《深入浅出Node.js》读书笔记7-1构建web应用
date: 2019-09-15 15:36:20
categories:
- 读书笔记
- 《深入浅出node.js》
tags:
- node
- 系统学习
description: Web应用
---
## 基础功能
本章内容将从http模块中服务器端的request事件开始分析。request事件发生于网络连接建立，客户端向服务器端发送报文，服务器端解析报文，发现HTTP请求端报头时。在已触发request事件前，它已准备好ServerRequest和ServerReponse对象以供对请求和响应报文对操作。

### 请求方法
HTTP_Parser在解析请求报文的时候，将请求行的请求方法设置为`req.method`。在RESTful类Web服务中请求方法十分重要。
- PUT，新建一个资源
- POST，更新一个资源
- GET，查看一个资源
- DELETE，删除一个资源

### 路径解析
HTTP_Parser在解析请求报文的时候，将请求行的第二部分设置为`req.url`。    
完整的URL地址是这样：
```
http://user:pass@host.com:8080/p/a/t/h?query=string#hash
```
我们可以根据路径查找磁盘中的文件，或者选择控制器。

### 查询字符串
使用`url.parse()`并传递第二个参数，可以将查询字符串解析为一个JSON对象。 

### Cookie
#### 1. 初识Cookie
Cookie是一个由浏览器和服务器共同协作实现的，Cookie的处理分为如下几步：
- 服务器向客户端发送Cookie
- 浏览器将Cookie保存
- 之后每次浏览器都会将Cookie发向服务器端。  

HTTP_parse会将cookie解析到req.headers.cookie。      
Cookie值是`key=value;key2=value2`形式，如果我们需要Cookie，解析它也十分容易
```javascript
var parseCookie = function(cookie){
    var cookies = {};
    if(!cookie) {
        return cookies;
    }
    var list = cookie.split(';');
    for(var i = 0; i < list.length;i++){
        var pair = list[i].spilt('=');
        cookies[pair[0].trim()] = pair[1];
    }
    return cookies;
}
```
响应报文中的Cookie值再`Set-Cookie`字段中，它的格式与请求中的格式不一样，主要选项如下：
```
Set-Cookie: name=value; Path=/; Expires=Sun, 23-Apr-23 09:01:35 GMT; Domain=.domain.com;
```
其中name=value是必须包含的部分，其余部分皆是可选参数。这些可选参数将会影响浏览器在后续将Cookie发送到服务器的行为：
- path: 表示这个Cookie影响到的路径，当前访问的路径不满足该匹配时，浏览器则不发送这个Cookie;
- Expires和Max-Age: 告知浏览器这个Cookie何时过期，如果不设置该选项，在关闭时会丢掉这个Cookie。Expires的值是一个UTC格式的时间字符串。Max-Age的值是数字，代表多少秒后过期。       
下面将Cookie序列化成符合规范的字符串
```javascript
var serialize = function (name, val, opt) {
    var pairs = [name + '=' + encode(val)];
    opt = opt || {};
    if (opt.maxAge) pairs.push('Max-Age=' + opt.maxAge);
    if (opt.domain) pairs.push('Domain=' + opt.domain);
    if (opt.path) pairs.push('Path=' + opt.path);
    if (opt.expires) pairs.push('Expires=' + opt.expires.toUTCString());
    if (opt.httpOnly) pairs.push('HttpOnly');
    if (opt.secure) pairs.push('Secure');
    return pairs.join('; ');
}; 
```

#### 2. Cookie的性能影响
一旦服务器向客户端发送了设置Cookie的意图，除非Cookie过期，否则客户端每次请求都会发送这些Cookie到服务器，一旦设置的Cookie过多，将会导致报头较大。
- 减少Cookie的大小
- 为静态组件使用不同的域名
- 减少DNS查询

### Session
Cookie最为严重的问题是可以在前后端进行修改，因此数据就极容易被篡改和伪造。所以，Cookie对于敏感数据的保护是无效的。      
Session的数据只保留在服务端，客户端无法修改，数据也无须在协议中每次都传递。     
虽然在服务端存储数据十分方便，但是如何将每个客户和服务器中的数据一一对应，有两种常见的实现方式：
1. 基于Cookie来实现用户和数据的映射     
一旦服务器启用了Session,他将约定一个键值作为Session的口令。口令存放在Cookie中。一旦服务器检查到用户请求Cookie中没有携带该值或者过期，它就会为之生产一个值，这个值是唯一且不重复的值，并设定超时时间。

2. 通过查询字符串来实现浏览器和服务器数据的对应     
它的原理是检查请求的查询字符串，如果没有值，会先生成新的带值的URL，然后形成跳转，让客户端重新发起请求。 
这种方案安全性更低。    

#### 1. Session与内存
