---
title: 《深入浅出Node.js》读书笔记8-1玩转进程
date: 2019-10-11 18:26:48
categories:
- 读书笔记
- 《深入浅出node.js》
tags:
- node
- 系统学习
description: 进程
---
Node在选型时决定在V8引擎之上构建，它和浏览器类似，运行在单个进程的单个线程上。好处是：程序状态是单一的，在没有多线程的情况下没有锁、线程同步问题，操作系统在调度时也因为较少上下文的切换，可以很好的提高CPU的使用率。   
同时带来两个缺点：
- CPU利用率
- 进程的健壮性

## 服务器的变迁
同步➡复制进程➡多线程➡事件驱动

## 多进程架构
![](http://img.aisss.top/Fn36wnr4FUXVwwbmg3RQT1smaBAT)      
上图是著名的Master-Worker模式，又称主从模式。主进程不负责具体的业务处理，而是负责调度或管理工作进程，工作进程负责具体的业务处理。


### 创建子进程
`child_process`模块提供了4个方法用于创建进程：
- `spawn()`: 启动一个子进程来执行命令
- `exec()`: 启动一个子进程来执行命令，与`spawn()`不同的是其接口不同，它有一个回调函数获知子进程的状况。
- `execFile()`: 启动一个子进程来执行可执行文件
- `fork()`: 与`spawn()`类似，不同点在于它创建的Node的子进程只需指定要执行的javascript文件模块即可。     

![](http://img.aisss.top/Fj6ptqqAh7F1bQ1FDzJyVLK50cK2)          
> 可执行文件：可以直接执行的文件，如果是javascript文件，它的首行内容必须添加如下代码
```
#!/usr/bin/env node
```

### 进程间通信
在Master-Worker模式中，要实现主进程管理工作和调度工作进程的功能，需要主进程和工作进程之间的通信。对于child_process模块，创建好了子进程，然后与父子进程间通信是十分容易的。  
子进程对象则由`send()`方法实现主进程向子进程发送数据，message事件实现收听子进程发来的数据。通过消息传递内容，而不是共享或直接操作相关资源，这是较为轻量和无依赖的做法。
```javascript
// parent.js
var cp = require('child_process');
var n = cp.fork(__dirname + '/sub.js');

n.on('message', function (m) { 
    console.log('PARENT got message:', m);
});
n.send({hello: 'world'});

// sub.js
process.on('message', function (m) { 
    console.log('CHILD got message:', m);
});

process.send({foo: 'bar'});
```
